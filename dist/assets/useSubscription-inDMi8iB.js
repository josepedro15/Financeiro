import{r as a}from"./vendor-CZTyH7vC.js";import{u as v,s as c}from"./index-COeLcZn-.js";const A="2dc520e3-5f19-4dfe-838b-1aca7238ae36",U=()=>{const{user:i}=v(),[s,h]=a.useState(null),[o,p]=a.useState(null),[g,_]=a.useState(!0),[w,m]=a.useState(null),n=i?.id===A,u=async()=>{if(i)try{_(!0),m(null);const{data:t,error:e}=await c.from("subscriptions").select("*").eq("user_id",i.id).single();if(e&&e.code!=="PGRST116")throw e;h(t);const r=new Date().toISOString().slice(0,7),{data:l,error:d}=await c.from("usage_tracking").select("*").eq("user_id",i.id).eq("month_year",r).single();if(d&&d.code!=="PGRST116")throw d;p(l)}catch(t){m(t instanceof Error?t.message:"Erro desconhecido")}finally{_(!1)}},f=async(t="transaction")=>{if(!i)return null;try{const{data:e,error:r}=await c.rpc("check_plan_limits",{target_user_id:i.id,check_type:t});if(r)throw r;return e?.[0]||null}catch{return null}},y=async(t,e=1)=>{if(!i||n)return!0;try{const{error:r}=await c.rpc("increment_usage",{target_user_id:i.id,usage_type:t,increment_by:e});if(r)throw r;return await u(),!0}catch{return!1}},S=async t=>n?!0:(await f(t))?.allowed||!1,b=t=>{switch(t){case"starter":return"Starter";case"business":return"Business";case"unlimited":return"Ilimitado";default:return"Desconhecido"}},D=t=>{switch(t){case"starter":return"R$ 79,90";case"business":return"R$ 159,90";case"unlimited":return"Gratuito";default:return"-"}},T=()=>{if(!s||!s.trial_ends_at)return!1;const t=new Date(s.trial_ends_at)>new Date,e=s.status==="trial",r=s.status==="active"&&t;return e||r},E=()=>{if(!s||!s.trial_ends_at)return 0;const t=new Date(s.trial_ends_at),e=new Date,r=t.getTime()-e.getTime(),l=Math.ceil(r/(1e3*60*60*24));return Math.max(0,l)},P=async t=>{if(!i||n)return!1;try{const e={starter:{monthly_transaction_limit:100,user_limit:1,client_limit:10},business:{monthly_transaction_limit:1e3,user_limit:3,client_limit:50}},{error:r}=await c.from("subscriptions").update({plan_type:t,status:"active",...e[t],updated_at:new Date().toISOString()}).eq("user_id",i.id);if(r)throw r;return await u(),!0}catch{return!1}};return a.useEffect(()=>{u()},[i]),{subscription:s,usage:o,loading:g,error:w,isMasterUser:n,loadSubscription:u,checkPlanLimits:f,incrementUsage:y,canPerformAction:S,getPlanName:b,getPlanPrice:D,isTrialActive:T,getTrialDaysLeft:E,upgradePlan:P,currentPlan:s?.plan_type||"starter",isUnlimited:s?.plan_type==="unlimited"||n,hasActiveSubscription:s?.status==="active",transactionLimit:s?.monthly_transaction_limit,userLimit:s?.user_limit,clientLimit:s?.client_limit,currentTransactions:o?.transactions_count||0,currentUsers:o?.users_count||1,currentClients:o?.clients_count||0}};export{U as u};
