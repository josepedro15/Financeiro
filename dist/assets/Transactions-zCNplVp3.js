import{j as e}from"./ui-REgLbvYD.js";import{R,r as _}from"./vendor-CZTyH7vC.js";import{s as p,a as U,d as B,e as G,f as H,g as X,h as Y,B as x,u as oe,k as ie,L as g,X as q}from"./index-_MNc14Zi.js";import{u as K}from"./useSubscription-xrrMMdqm.js";import{I}from"./input-bWitaxRI.js";import{S,a as E,b as F,c as A,d as l}from"./select-3UyX_8h7.js";import{D as le,a as de,b as ue,c as me,d as he,e as xe}from"./dialog-BMwjU1Zo.js";import{C as pe}from"./crown-PIdaXEqU.js";import{L as V}from"./lock-DJBSycho.js";import{T as fe}from"./triangle-alert-DSgmNfhW.js";import{P as J}from"./plus-CIlm-0KQ.js";import{F as L}from"./filter-D_HbdzGF.js";import{D as je}from"./dollar-sign-7cb5Iagd.js";import{A as ge}from"./arrow-up-right-DXDcmv0V.js";import{A as ve}from"./arrow-down-right-B47EWflC.js";import{C as Ne}from"./calendar-CY0BW7wS.js";import{S as ye}from"./square-pen-CzggzZjN.js";import{T as be}from"./trash-2-CZh_roe9.js";import"./supabase-DfbQpoin.js";import"./charts-DE-LwN1H.js";import"./chevron-up-BUDBqTrD.js";import"./check-BJ-UlnbB.js";async function _e(){try{const{data:{user:s},error:r}=await p.auth.getUser();if(r)return{success:!1,error:"Erro de autenticação"};if(!s)return{success:!1,error:"Usuário não autenticado"};const{data:n,error:t}=await p.from("transactions").select("*").limit(1);if(t)return{success:!1,error:`Erro transações: ${t.message}`};const{data:m,error:h}=await p.from("clients").select("*").limit(1);if(h)return{success:!1,error:`Erro clientes: ${h.message}`};const{data:T,error:w}=await p.from("accounts").select("*").limit(1);return w?{success:!1,error:`Erro contas: ${w.message}`}:{success:!0}}catch{return{success:!1,error:"Erro geral no teste"}}}async function we(){try{const{data:{user:s}}=await p.auth.getUser();if(!s)return{success:!1,error:"Usuário não autenticado"};const r={user_id:s.id,description:"Teste de autorização",amount:.01,transaction_type:"income",category:"Teste",transaction_date:new Date().toISOString().split("T")[0],account_id:"00000000-0000-0000-0000-000000000000",client_id:null},{error:n}=await p.from("transactions").insert([r]);return n?{success:!0,message:"client_id null não é o problema"}:{success:!0,message:"Teste passou"}}catch{return{success:!1,error:"Erro no teste"}}}function Q(s){try{const r=new Date(s),n=r.getFullYear(),t=r.getMonth()+1;if(n!==2025)return null;const m=["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];return{table:`transactions_${n}_${String(t).padStart(2,"0")}`,month:m[t],monthNum:t,year:n}}catch{return null}}function Te(s=2025){return["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].map((n,t)=>({table:`transactions_${s}_${String(t+1).padStart(2,"0")}`,month:n,monthNum:t+1,year:s}))}function Ce(s){return Q(s)!==null}function M(s){const r=Q(s);return r?r.table:"transactions"}async function W(s){try{const r=M(s.transaction_date),n=Ce(s.transaction_date),{data:t,error:m}=await p.from(r).insert([s]).select();return m?{success:!1,error:m.message,tableName:r}:{success:!0,tableName:r,data:t}}catch(r){return{success:!1,error:r.message,tableName:"unknown"}}}async function De(s,r,n){try{const t=M(r.transaction_date),m=M(n.transaction_date);if(t===m){const{data:w,error:f}=await p.from(t).update(n).eq("id",s).select();return f?{success:!1,error:f.message,tableName:t}:{success:!0,tableName:t,data:w}}const h=await W({...n});if(!h.success)return h;const{error:T}=await p.from(t).delete().eq("id",s);return h}catch(t){return{success:!1,error:t.message,tableName:"unknown"}}}async function Se(s,r){try{const n=M(r),{error:t}=await p.from(n).delete().eq("id",s);return t?{success:!1,error:t.message,tableName:n}:{success:!0,tableName:n}}catch(n){return{success:!1,error:n.message,tableName:"unknown"}}}const Ee=({children:s,feature:r,fallback:n})=>{const{isMasterUser:t,isTrialActive:m,canPerformAction:h,getPlanName:T,currentPlan:w}=K(),f=U(),[v,C]=R.useState(null);if(R.useEffect(()=>{(async()=>{if(t){C(!0);return}const D=await h(r);C(D)})()},[t,h,r]),v===null)return e.jsx(e.Fragment,{children:s});if(v)return e.jsx(e.Fragment,{children:s});if(n)return e.jsx(e.Fragment,{children:n});const o=()=>{switch(r){case"transaction":return"transações";case"user":return"usuários";case"client":return"clientes";default:return"recursos"}},d=()=>{switch(r){case"transaction":return e.jsx(fe,{className:"w-6 h-6"});case"user":return e.jsx(V,{className:"w-6 h-6"});case"client":return e.jsx(V,{className:"w-6 h-6"});default:return e.jsx(V,{className:"w-6 h-6"})}};return e.jsxs(B,{className:"w-full max-w-md mx-auto",children:[e.jsxs(G,{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-4 p-3 bg-yellow-100 rounded-full w-fit",children:d()}),e.jsx(H,{className:"text-lg",children:"Limite Atingido"}),e.jsxs(X,{children:["Você atingiu o limite de ",o()," do seu plano atual."]})]}),e.jsxs(Y,{className:"space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["Plano atual: ",e.jsx("span",{className:"font-medium",children:T(w)})]}),m()&&e.jsx("p",{className:"text-sm text-blue-600 bg-blue-50 p-2 rounded",children:"⏰ Você está no período de teste gratuito"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"w-full",onClick:()=>f("/subscription"),children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),m()?"Escolher Plano":"Fazer Upgrade"]}),e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>f("/dashboard"),children:"Voltar ao Dashboard"})]})]})]})};function We(){const{user:s}=oe();K();const r=U(),{toast:n}=ie(),[t,m]=_.useState([]),[h,T]=_.useState(!0),[w,f]=_.useState(!1),[v,C]=_.useState(null),[o,d]=_.useState({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),[i,D]=_.useState({month:"all",day:"all",type:"all",account:"all"}),[O,$]=_.useState([]),Z=[{id:"pj",name:"Conta PJ"},{id:"checkout",name:"Conta Checkout"}];_.useEffect(()=>{if(!s){r("/auth");return}z()},[s,r]);const P=()=>{D({month:"all",day:"all",type:"all",account:"all"}),$(t)};_.useEffect(()=>{let a=[...t];i.month&&i.month!=="all"&&(a=a.filter(c=>(new Date(c.transaction_date).getMonth()+1).toString()===i.month)),i.day&&i.day!=="all"&&(a=a.filter(c=>new Date(c.transaction_date).getDate().toString()===i.day)),i.type&&i.type!=="all"&&(a=a.filter(c=>c.transaction_type===i.type)),i.account&&i.account!=="all"&&(a=a.filter(c=>c.account_name===i.account)),$(a)},[t,i]);const z=async()=>{if(s)try{T(!0);let a=[];const c=Te(2025);for(const b of c)try{const{data:j,error:u}=await p.from(b.table).select("*").eq("user_id",s.id);if(!u){const k=j||[];a=[...a,...k]}}catch{}try{const{data:b,error:j}=await p.from("transactions").select("*").eq("user_id",s.id);if(!j){const u=b||[];a=[...a,...u]}}catch{}const y=a.filter((b,j,u)=>j===u.findIndex(k=>k.id===b.id)).sort((b,j)=>new Date(j.transaction_date).getTime()-new Date(b.transaction_date).getTime());m(y),$(y)}catch{n({title:"Erro",description:"Erro inesperado ao carregar dados",variant:"destructive"})}finally{T(!1)}},ee=async a=>{if(a.preventDefault(),alert("SUBMIT INICIADO - Data: "+o.transaction_date),!o.amount||parseFloat(o.amount)<=0){alert("Valor deve ser maior que zero");return}if(!o.account_name){alert("Selecione uma conta");return}if(!o.transaction_date){alert("Selecione uma data");return}try{const c=o.transaction_date,N=new Date(c),y=N.getDay(),b=N.getDate();if(y===0){const[u,k,ne]=c.split("-"),ce=`${u}-${k}-${ne}`;alert(`DOMINGO DETECTADO!
Data original: ${c}
Dia da semana: ${y}
Data corrigida: ${ce}`)}const j={user_id:s.id,description:o.description||"",amount:parseFloat(o.amount),transaction_type:o.transaction_type,category:o.category||"",transaction_date:c,account_name:o.account_name,client_name:o.client_name||null};if(v){const u=await De(v.id,v,j);if(!u.success)throw new Error(u.error||"Erro ao atualizar transação");alert("Transação atualizada com sucesso!")}else{const u=await W(j);if(!u.success)throw new Error(u.error||"Erro ao criar transação");alert("Transação criada com sucesso! Data: "+c)}d({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),C(null),f(!1),z()}catch(c){alert("Erro: "+c.message)}},ae=a=>{C(a),d({description:a.description,amount:a.amount.toString(),transaction_type:a.transaction_type,category:a.category||"",transaction_date:a.transaction_date,client_name:a.client_name||"",account_name:a.account_name}),f(!0)},se=async a=>{if(confirm("Tem certeza que deseja excluir esta transação?"))try{const c=t.find(y=>y.id===a);if(!c)throw new Error("Transação não encontrada");const N=await Se(a,c.transaction_date);if(!N.success)throw new Error(N.error||"Erro ao excluir transação");n({title:"Sucesso",description:`Transação excluída com sucesso da tabela ${N.tableName}`}),z()}catch(c){c.code==="PGRST116"||c.message?.includes("permission")?n({title:"Erro de Autorização",description:"Você não tem permissão para excluir esta transação. Verifique se está logado corretamente.",variant:"destructive"}):n({title:"Erro",description:c.message||"Erro desconhecido ao excluir transação",variant:"destructive"})}},te=a=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a),re=async()=>{const a=await _e(),c=await we();a.success&&c.success?n({title:"Testes Concluídos",description:"Todos os testes de autorização passaram!"}):n({title:"Testes Falharam",description:`Problemas encontrados: ${a.error||c.error}`,variant:"destructive"})};return h?e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("p",{className:"ml-4 text-muted-foreground",children:"Carregando transações..."})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(x,{variant:"ghost",onClick:()=>r("/dashboard"),children:"← Dashboard"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Transações"}),e.jsx(x,{variant:"outline",size:"sm",onClick:re,className:"ml-4",children:"🧪 Testar Auth"})]}),e.jsx(Ee,{feature:"transaction",children:e.jsxs(le,{open:w,onOpenChange:f,children:[e.jsx(de,{asChild:!0,children:e.jsxs(x,{onClick:()=>{C(null),d({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""})},children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Nova Transação"]})}),e.jsxs(ue,{className:"sm:max-w-[500px]",children:[e.jsxs(me,{children:[e.jsx(he,{children:v?"Editar Transação":"Nova Transação"}),e.jsx(xe,{children:v?"Edite os dados da transação":"Adicione uma nova transação financeira"})]}),e.jsxs("form",{onSubmit:ee,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"description",children:"Descrição (Opcional)"}),e.jsx(I,{id:"description",placeholder:"Descrição da transação",value:o.description,onChange:a=>d({...o,description:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"amount",children:"Valor"}),e.jsx(I,{id:"amount",type:"number",step:"0.01",placeholder:"0,00",value:o.amount,onChange:a=>d({...o,amount:a.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"transaction_type",children:"Tipo"}),e.jsxs(S,{value:o.transaction_type,onValueChange:a=>d({...o,transaction_type:a}),children:[e.jsx(E,{children:e.jsx(F,{})}),e.jsxs(A,{children:[e.jsx(l,{value:"income",children:"Receita"}),e.jsx(l,{value:"expense",children:"Despesa"}),e.jsx(l,{value:"transfer",children:"Transferência"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"account_name",children:"Conta"}),e.jsxs(S,{value:o.account_name||void 0,onValueChange:a=>d({...o,account_name:a}),children:[e.jsx(E,{children:e.jsx(F,{placeholder:"Selecione uma conta"})}),e.jsx(A,{children:Z.map(a=>e.jsx(l,{value:a.name,children:a.name},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"client_name",children:"Cliente (Opcional)"}),e.jsx(I,{id:"client_name",placeholder:"Digite o nome do cliente",value:o.client_name,onChange:a=>d({...o,client_name:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"category",children:"Categoria"}),e.jsx(I,{id:"category",placeholder:"Ex: Vendas, Marketing",value:o.category,onChange:a=>d({...o,category:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"transaction_date",children:"Data"}),e.jsx(I,{id:"transaction_date",type:"date",value:o.transaction_date,onChange:a=>{d({...o,transaction_date:a.target.value})},required:!0})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>f(!1),children:"Cancelar"}),e.jsx(x,{type:"submit",onClick:()=>{},children:v?"Atualizar":"Criar"})]})]})]})]})})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:e.jsxs(B,{className:"shadow-finance-md",children:[e.jsxs(G,{children:[e.jsx(H,{children:"Lista de Transações"}),e.jsx(X,{children:"Gerencie todas as suas movimentações financeiras"})]}),e.jsx("div",{className:"px-6 pb-4 border-b",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Filtros:"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"month-filter",className:"text-xs",children:"Mês:"}),e.jsxs(S,{value:i.month,onValueChange:a=>D({...i,month:a}),children:[e.jsx(E,{className:"w-32 h-8",children:e.jsx(F,{placeholder:"Todos"})}),e.jsxs(A,{children:[e.jsx(l,{value:"all",children:"Todos"}),e.jsx(l,{value:"1",children:"Janeiro"}),e.jsx(l,{value:"2",children:"Fevereiro"}),e.jsx(l,{value:"3",children:"Março"}),e.jsx(l,{value:"4",children:"Abril"}),e.jsx(l,{value:"5",children:"Maio"}),e.jsx(l,{value:"6",children:"Junho"}),e.jsx(l,{value:"7",children:"Julho"}),e.jsx(l,{value:"8",children:"Agosto"}),e.jsx(l,{value:"9",children:"Setembro"}),e.jsx(l,{value:"10",children:"Outubro"}),e.jsx(l,{value:"11",children:"Novembro"}),e.jsx(l,{value:"12",children:"Dezembro"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"day-filter",className:"text-xs",children:"Dia:"}),e.jsxs(S,{value:i.day,onValueChange:a=>D({...i,day:a}),children:[e.jsx(E,{className:"w-20 h-8",children:e.jsx(F,{placeholder:"Todos"})}),e.jsxs(A,{children:[e.jsx(l,{value:"all",children:"Todos"}),Array.from({length:31},(a,c)=>c+1).map(a=>e.jsx(l,{value:a.toString(),children:a},a))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"type-filter",className:"text-xs",children:"Tipo:"}),e.jsxs(S,{value:i.type,onValueChange:a=>D({...i,type:a}),children:[e.jsx(E,{className:"w-28 h-8",children:e.jsx(F,{placeholder:"Todos"})}),e.jsxs(A,{children:[e.jsx(l,{value:"all",children:"Todos"}),e.jsx(l,{value:"income",children:"Receita"}),e.jsx(l,{value:"expense",children:"Despesa"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"account-filter",className:"text-xs",children:"Conta:"}),e.jsxs(S,{value:i.account,onValueChange:a=>D({...i,account:a}),children:[e.jsx(E,{className:"w-32 h-8",children:e.jsx(F,{placeholder:"Todas"})}),e.jsxs(A,{children:[e.jsx(l,{value:"all",children:"Todas"}),e.jsx(l,{value:"Conta PJ",children:"Conta PJ"}),e.jsx(l,{value:"Conta Checkout",children:"Conta Checkout"})]})]})]}),(i.month!=="all"||i.day!=="all"||i.type!=="all"||i.account!=="all")&&e.jsxs(x,{variant:"outline",size:"sm",onClick:P,className:"h-8",children:[e.jsx(q,{className:"h-3 w-3 mr-1"}),"Limpar"]}),e.jsxs("div",{className:"ml-auto text-xs text-muted-foreground",children:[O.length," de ",t.length," transações"]})]})}),e.jsx(Y,{children:h?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando transações..."})]}):O.length===0?e.jsx("div",{className:"text-center py-8",children:t.length===0?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transação encontrada. Adicione sua primeira transação."}),e.jsxs(x,{onClick:()=>{C(null),d({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),f(!0)},children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Nova Transação"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transação encontrada com os filtros aplicados."}),e.jsxs(x,{variant:"outline",onClick:P,children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})]})}):e.jsx("div",{className:"space-y-4",children:O.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`p-2 rounded-full ${a.transaction_type==="income"?"bg-success/10":a.transaction_type==="expense"?"bg-destructive/10":"bg-info/10"}`,children:a.transaction_type==="income"?e.jsx(ge,{className:"h-4 w-4 text-success"}):a.transaction_type==="expense"?e.jsx(ve,{className:"h-4 w-4 text-destructive"}):e.jsx(Ne,{className:"h-4 w-4 text-info"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.description||"Sem descrição"}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:a.client_name||"Sem cliente"}),e.jsx("span",{children:"•"}),e.jsx("span",{children:a.account_name}),e.jsx("span",{children:"•"}),e.jsx("span",{children:new Date(a.transaction_date).toLocaleDateString("pt-BR")}),a.category&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsx("span",{children:a.category})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`font-semibold ${a.transaction_type==="income"?"text-success":a.transaction_type==="expense"?"text-destructive":"text-info"}`,children:[a.transaction_type==="income"?"+":a.transaction_type==="expense"?"-":"",te(Number(a.amount))]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>ae(a),children:e.jsx(ye,{className:"w-4 h-4"})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>se(a.id),children:e.jsx(be,{className:"w-4 h-4"})})]})]})]},a.id))})})]})})]})}export{We as default};
