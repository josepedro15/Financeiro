import{j as e}from"./ui-GI4EfHd4.js";import{r as v}from"./vendor-CZTyH7vC.js";import{s as u,u as ee,a as ae,e as se,X as J}from"./index-Wewmnpcn.js";import{D as P,B as k,A as te,a as re}from"./badge-CxzGO0X7.js";import{C as U}from"./calendar-Dx7z57hE.js";import{C as ne,a as ce,b as oe,c as ie,d as le}from"./card-DViYy-2D.js";import{B as f}from"./button-DtDkGFt8.js";import{I}from"./input-4-G2lXk2.js";import{L as x}from"./label-D6QaJsOg.js";import{S as T,a as w,b as C,c as S,d as i}from"./select-GY33cGe_.js";import{D as de,a as me,b as ue,c as he,d as xe,e as pe,T as fe}from"./dialog-Bmgr8XNp.js";import{P as L}from"./plus-CAXmyunV.js";import{F as B}from"./filter-DQcDAZKO.js";import{D as je}from"./dollar-sign-DXp9D2zg.js";import{S as ge}from"./square-pen-Cg59BXOk.js";import"./supabase-DfbQpoin.js";import"./charts-DE-LwN1H.js";import"./check-CD6qwei3.js";async function ve(){try{const{data:{user:s},error:n}=await u.auth.getUser();if(n)return{success:!1,error:"Erro de autentica√ß√£o"};if(!s)return{success:!1,error:"Usu√°rio n√£o autenticado"};const{data:r,error:t}=await u.from("transactions").select("*").limit(1);if(t)return{success:!1,error:`Erro transa√ß√µes: ${t.message}`};const{data:j,error:g}=await u.from("clients").select("*").limit(1);if(g)return{success:!1,error:`Erro clientes: ${g.message}`};const{data:D,error:_}=await u.from("accounts").select("*").limit(1);return _?{success:!1,error:`Erro contas: ${_.message}`}:{success:!0}}catch{return{success:!1,error:"Erro geral no teste"}}}async function ye(){try{const{data:{user:s}}=await u.auth.getUser();if(!s)return{success:!1,error:"Usu√°rio n√£o autenticado"};const n={user_id:s.id,description:"Teste de autoriza√ß√£o",amount:.01,transaction_type:"income",category:"Teste",transaction_date:new Date().toISOString().split("T")[0],account_id:"00000000-0000-0000-0000-000000000000",client_id:null},{error:r}=await u.from("transactions").insert([n]);return r?{success:!0,message:"client_id null n√£o √© o problema"}:{success:!0,message:"Teste passou"}}catch{return{success:!1,error:"Erro no teste"}}}function R(s){try{const n=new Date(s),r=n.getFullYear(),t=n.getMonth()+1;if(r!==2025)return null;const j=["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];return{table:`transactions_${r}_${String(t).padStart(2,"0")}`,month:j[t],monthNum:t,year:r}}catch{return null}}function Ne(s=2025){return["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].map((r,t)=>({table:`transactions_${s}_${String(t+1).padStart(2,"0")}`,month:r,monthNum:t+1,year:s}))}function G(s){return R(s)!==null}function z(s){const n=R(s);return n?n.table:"transactions"}async function H(s){try{const n=z(s.transaction_date),r=G(s.transaction_date),{data:t,error:j}=await u.from(n).insert([s]).select();return j?{success:!1,error:j.message,tableName:n}:{success:!0,tableName:n,data:t}}catch(n){return{success:!1,error:n.message,tableName:"unknown"}}}async function be(s,n,r){try{const t=z(n.transaction_date),j=z(r.transaction_date);if(t===j){const{data:_,error:y}=await u.from(t).update(r).eq("id",s).select();return y?{success:!1,error:y.message,tableName:t}:{success:!0,tableName:t,data:_}}const g=await H({...r});if(!g.success)return g;const{error:D}=await u.from(t).delete().eq("id",s);return g}catch(t){return{success:!1,error:t.message,tableName:"unknown"}}}async function _e(s,n){try{const r=z(n),{error:t}=await u.from(r).delete().eq("id",s);return t?{success:!1,error:t.message,tableName:r}:{success:!0,tableName:r}}catch(r){return{success:!1,error:r.message,tableName:"unknown"}}}function Te({transactionDate:s,className:n=""}){if(!s)return null;const r=G(s),t=R(s);return r&&t?e.jsxs("div",{className:`flex items-center gap-2 ${n}`,children:[e.jsx(P,{className:"h-4 w-4 text-blue-600"}),e.jsxs(k,{variant:"secondary",className:"text-xs",children:["Tabela: ",t.table]}),e.jsxs(k,{variant:"outline",className:"text-xs",children:[t.month,"/",t.year]})]}):e.jsxs("div",{className:`flex items-center gap-2 ${n}`,children:[e.jsx(P,{className:"h-4 w-4 text-gray-600"}),e.jsx(k,{variant:"secondary",className:"text-xs",children:"Tabela: transactions (principal)"}),e.jsxs(k,{variant:"outline",className:"text-xs",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Outras datas"]})]})}function Le(){const{user:s}=ee(),n=ae(),{toast:r}=se(),[t,j]=v.useState([]),[g,D]=v.useState(!0),[_,y]=v.useState(!1),[d,A]=v.useState(null),[l,h]=v.useState({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),[o,E]=v.useState({month:"all",day:"all",type:"all",account:"all"}),[M,$]=v.useState([]),X=[{id:"pj",name:"Conta PJ"},{id:"checkout",name:"Conta Checkout"}];v.useEffect(()=>{if(!s){n("/auth");return}O()},[s,n]);const V=()=>{E({month:"all",day:"all",type:"all",account:"all"}),$(t)};v.useEffect(()=>{let a=[...t];o.month&&o.month!=="all"&&(a=a.filter(c=>(new Date(c.transaction_date).getMonth()+1).toString()===o.month)),o.day&&o.day!=="all"&&(a=a.filter(c=>new Date(c.transaction_date).getDate().toString()===o.day)),o.type&&o.type!=="all"&&(a=a.filter(c=>c.transaction_type===o.type)),o.account&&o.account!=="all"&&(a=a.filter(c=>c.account_name===o.account)),$(a)},[t,o]);const O=async()=>{if(s)try{D(!0);let a=[];const c=Ne(2025);for(const N of c)try{const{data:b,error:F}=await u.from(N.table).select("*").eq("user_id",s.id);if(!F){const q=b||[];a=[...a,...q]}}catch{}try{const{data:N,error:b}=await u.from("transactions").select("*").eq("user_id",s.id);if(!b){const F=N||[];a=[...a,...F]}}catch{}const p=a.filter((N,b,F)=>b===F.findIndex(q=>q.id===N.id)).sort((N,b)=>new Date(b.transaction_date).getTime()-new Date(N.transaction_date).getTime());j(p),$(p)}catch{r({title:"Erro",description:"Erro inesperado ao carregar dados",variant:"destructive"})}finally{D(!1)}},Y=async a=>{if(a.preventDefault(),!!s){if(!l.account_name){r({title:"Erro",description:"Selecione uma conta para a transa√ß√£o",variant:"destructive"});return}try{const c={user_id:s.id,description:l.description,amount:parseFloat(l.amount),transaction_type:l.transaction_type,category:l.category,transaction_date:l.transaction_date,account_name:l.account_name,client_name:l.client_name||null};if(d){const m={user_id:d.user_id||s.id,description:d.description,amount:d.amount,transaction_type:d.transaction_type,category:d.category,transaction_date:d.transaction_date,account_name:d.account_name,client_name:d.client_name},p=await be(d.id,m,c);if(!p.success)throw new Error(p.error||"Erro ao atualizar transa√ß√£o");r({title:"Sucesso",description:`Transa√ß√£o atualizada com sucesso na tabela ${p.tableName}`})}else{const m=await H(c);if(!m.success)throw new Error(m.error||"Erro ao criar transa√ß√£o");r({title:"Sucesso",description:`Transa√ß√£o criada com sucesso na tabela ${m.tableName}`})}h({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),A(null),y(!1),O()}catch(c){c.code==="PGRST116"||c.message?.includes("permission")?r({title:"Erro de Autoriza√ß√£o",description:"Voc√™ n√£o tem permiss√£o para realizar esta a√ß√£o. Verifique se est√° logado corretamente.",variant:"destructive"}):r({title:"Erro",description:c.message||"Erro desconhecido ao processar transa√ß√£o",variant:"destructive"})}}},K=a=>{A(a),h({description:a.description,amount:a.amount.toString(),transaction_type:a.transaction_type,category:a.category||"",transaction_date:a.transaction_date,client_name:a.client_name||"",account_name:a.account_name}),y(!0)},Q=async a=>{if(confirm("Tem certeza que deseja excluir esta transa√ß√£o?"))try{const c=t.find(p=>p.id===a);if(!c)throw new Error("Transa√ß√£o n√£o encontrada");const m=await _e(a,c.transaction_date);if(!m.success)throw new Error(m.error||"Erro ao excluir transa√ß√£o");r({title:"Sucesso",description:`Transa√ß√£o exclu√≠da com sucesso da tabela ${m.tableName}`}),O()}catch(c){c.code==="PGRST116"||c.message?.includes("permission")?r({title:"Erro de Autoriza√ß√£o",description:"Voc√™ n√£o tem permiss√£o para excluir esta transa√ß√£o. Verifique se est√° logado corretamente.",variant:"destructive"}):r({title:"Erro",description:c.message||"Erro desconhecido ao excluir transa√ß√£o",variant:"destructive"})}},W=a=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a),Z=async()=>{const a=await ve(),c=await ye();a.success&&c.success?r({title:"Testes Conclu√≠dos",description:"Todos os testes de autoriza√ß√£o passaram!"}):r({title:"Testes Falharam",description:`Problemas encontrados: ${a.error||c.error}`,variant:"destructive"})};return g?e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("p",{className:"ml-4 text-muted-foreground",children:"Carregando transa√ß√µes..."})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(f,{variant:"ghost",onClick:()=>n("/dashboard"),children:"‚Üê Dashboard"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Transa√ß√µes"}),e.jsx(f,{variant:"outline",size:"sm",onClick:Z,className:"ml-4",children:"üß™ Testar Auth"})]}),e.jsxs(de,{open:_,onOpenChange:y,children:[e.jsx(me,{asChild:!0,children:e.jsxs(f,{onClick:()=>{A(null),h({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_id:"",account_id:""})},children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),"Nova Transa√ß√£o"]})}),e.jsxs(ue,{className:"sm:max-w-[500px]",children:[e.jsxs(he,{children:[e.jsx(xe,{children:d?"Editar Transa√ß√£o":"Nova Transa√ß√£o"}),e.jsx(pe,{children:d?"Edite os dados da transa√ß√£o":"Adicione uma nova transa√ß√£o financeira"})]}),e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"description",children:"Descri√ß√£o (Opcional)"}),e.jsx(I,{id:"description",placeholder:"Descri√ß√£o da transa√ß√£o",value:l.description,onChange:a=>h({...l,description:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"amount",children:"Valor"}),e.jsx(I,{id:"amount",type:"number",step:"0.01",placeholder:"0,00",value:l.amount,onChange:a=>h({...l,amount:a.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"transaction_type",children:"Tipo"}),e.jsxs(T,{value:l.transaction_type,onValueChange:a=>h({...l,transaction_type:a}),children:[e.jsx(w,{children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(i,{value:"income",children:"Receita"}),e.jsx(i,{value:"expense",children:"Despesa"}),e.jsx(i,{value:"transfer",children:"Transfer√™ncia"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"account_name",children:"Conta"}),e.jsxs(T,{value:l.account_name||void 0,onValueChange:a=>h({...l,account_name:a}),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Selecione uma conta"})}),e.jsx(S,{children:X.map(a=>e.jsx(i,{value:a.name,children:a.name},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"client_name",children:"Cliente (Opcional)"}),e.jsx(I,{id:"client_name",placeholder:"Digite o nome do cliente",value:l.client_name,onChange:a=>h({...l,client_name:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"category",children:"Categoria"}),e.jsx(I,{id:"category",placeholder:"Ex: Vendas, Marketing",value:l.category,onChange:a=>h({...l,category:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"transaction_date",children:"Data"}),e.jsx(I,{id:"transaction_date",type:"date",value:l.transaction_date,onChange:a=>h({...l,transaction_date:a.target.value}),required:!0}),e.jsx(Te,{transactionDate:l.transaction_date,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(f,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"}),e.jsx(f,{type:"submit",children:d?"Atualizar":"Criar"})]})]})]})]})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:e.jsxs(ne,{className:"shadow-finance-md",children:[e.jsxs(ce,{children:[e.jsx(oe,{children:"Lista de Transa√ß√µes"}),e.jsx(ie,{children:"Gerencie todas as suas movimenta√ß√µes financeiras"})]}),e.jsx("div",{className:"px-6 pb-4 border-b",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Filtros:"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"month-filter",className:"text-xs",children:"M√™s:"}),e.jsxs(T,{value:o.month,onValueChange:a=>E({...o,month:a}),children:[e.jsx(w,{className:"w-32 h-8",children:e.jsx(C,{placeholder:"Todos"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todos"}),e.jsx(i,{value:"1",children:"Janeiro"}),e.jsx(i,{value:"2",children:"Fevereiro"}),e.jsx(i,{value:"3",children:"Mar√ßo"}),e.jsx(i,{value:"4",children:"Abril"}),e.jsx(i,{value:"5",children:"Maio"}),e.jsx(i,{value:"6",children:"Junho"}),e.jsx(i,{value:"7",children:"Julho"}),e.jsx(i,{value:"8",children:"Agosto"}),e.jsx(i,{value:"9",children:"Setembro"}),e.jsx(i,{value:"10",children:"Outubro"}),e.jsx(i,{value:"11",children:"Novembro"}),e.jsx(i,{value:"12",children:"Dezembro"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"day-filter",className:"text-xs",children:"Dia:"}),e.jsxs(T,{value:o.day,onValueChange:a=>E({...o,day:a}),children:[e.jsx(w,{className:"w-20 h-8",children:e.jsx(C,{placeholder:"Todos"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todos"}),Array.from({length:31},(a,c)=>c+1).map(a=>e.jsx(i,{value:a.toString(),children:a},a))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"type-filter",className:"text-xs",children:"Tipo:"}),e.jsxs(T,{value:o.type,onValueChange:a=>E({...o,type:a}),children:[e.jsx(w,{className:"w-28 h-8",children:e.jsx(C,{placeholder:"Todos"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todos"}),e.jsx(i,{value:"income",children:"Receita"}),e.jsx(i,{value:"expense",children:"Despesa"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"account-filter",className:"text-xs",children:"Conta:"}),e.jsxs(T,{value:o.account,onValueChange:a=>E({...o,account:a}),children:[e.jsx(w,{className:"w-32 h-8",children:e.jsx(C,{placeholder:"Todas"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todas"}),e.jsx(i,{value:"Conta PJ",children:"Conta PJ"}),e.jsx(i,{value:"Conta Checkout",children:"Conta Checkout"})]})]})]}),(o.month!=="all"||o.day!=="all"||o.type!=="all"||o.account!=="all")&&e.jsxs(f,{variant:"outline",size:"sm",onClick:V,className:"h-8",children:[e.jsx(J,{className:"h-3 w-3 mr-1"}),"Limpar"]}),e.jsxs("div",{className:"ml-auto text-xs text-muted-foreground",children:[M.length," de ",t.length," transa√ß√µes"]})]})}),e.jsx(le,{children:g?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando transa√ß√µes..."})]}):M.length===0?e.jsx("div",{className:"text-center py-8",children:t.length===0?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transa√ß√£o encontrada. Adicione sua primeira transa√ß√£o."}),e.jsxs(f,{onClick:()=>{A(null),h({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),y(!0)},children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),"Nova Transa√ß√£o"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transa√ß√£o encontrada com os filtros aplicados."}),e.jsxs(f,{variant:"outline",onClick:V,children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})]})}):e.jsx("div",{className:"space-y-4",children:M.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`p-2 rounded-full ${a.transaction_type==="income"?"bg-success/10":a.transaction_type==="expense"?"bg-destructive/10":"bg-info/10"}`,children:a.transaction_type==="income"?e.jsx(te,{className:"h-4 w-4 text-success"}):a.transaction_type==="expense"?e.jsx(re,{className:"h-4 w-4 text-destructive"}):e.jsx(U,{className:"h-4 w-4 text-info"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.description||"Sem descri√ß√£o"}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:a.client_name||"Sem cliente"}),e.jsx("span",{children:"‚Ä¢"}),e.jsx("span",{children:a.account_name}),e.jsx("span",{children:"‚Ä¢"}),e.jsx("span",{children:new Date(a.transaction_date).toLocaleDateString("pt-BR")}),a.category&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsx("span",{children:a.category})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`font-semibold ${a.transaction_type==="income"?"text-success":a.transaction_type==="expense"?"text-destructive":"text-info"}`,children:[a.transaction_type==="income"?"+":a.transaction_type==="expense"?"-":"",W(Number(a.amount))]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(f,{size:"sm",variant:"ghost",onClick:()=>K(a),children:e.jsx(ge,{className:"w-4 h-4"})}),e.jsx(f,{size:"sm",variant:"ghost",onClick:()=>Q(a.id),children:e.jsx(fe,{className:"w-4 h-4"})})]})]})]},a.id))})})]})})]})}export{Le as default};
