import{j as e}from"./ui-REgLbvYD.js";import{R as G,r as w}from"./vendor-CZTyH7vC.js";import{s as p,a as K,d as Q,e as W,f as Z,g as ee,h as ae,B as x,u as ue,k as me,L as g,X as H}from"./index-DnicOMcL.js";import{u as se}from"./useSubscription-DIqMQkzj.js";import{I}from"./input-WLmGkkMH.js";import{S as C,a as S,b as D,c as E,d as o}from"./select-BULg2jsU.js";import{D as he,a as xe,b as pe,c as fe,d as je,e as ge}from"./dialog-BVwi1TG7.js";import{C as ve}from"./crown-CHiZ7Vga.js";import{L as J}from"./lock-DsP5y720.js";import{T as ye}from"./triangle-alert-B-Srk1gU.js";import{P as X}from"./plus-BZw1qXzF.js";import{F as Y}from"./filter-BsNs7GLY.js";import{D as Ne}from"./dollar-sign-BkzFnFEs.js";import{A as be}from"./arrow-up-right-D9cewujn.js";import{A as _e}from"./arrow-down-right-C5c5E8Rk.js";import{C as we}from"./calendar-zKickOkm.js";import{S as Te}from"./square-pen-Bp_SMlgf.js";import{T as Ce}from"./trash-2-C-cX3sBL.js";import"./supabase-DfbQpoin.js";import"./charts-DE-LwN1H.js";import"./chevron-up-Bhp3mOHo.js";import"./check-MAI7uQDe.js";async function Se(){try{const{data:{user:s},error:r}=await p.auth.getUser();if(r)return{success:!1,error:"Erro de autenticação"};if(!s)return{success:!1,error:"Usuário não autenticado"};const{data:i,error:n}=await p.from("transactions").select("*").limit(1);if(n)return{success:!1,error:`Erro transações: ${n.message}`};const{data:f,error:v}=await p.from("clients").select("*").limit(1);if(v)return{success:!1,error:`Erro clientes: ${v.message}`};const{data:F,error:y}=await p.from("accounts").select("*").limit(1);return y?{success:!1,error:`Erro contas: ${y.message}`}:{success:!0}}catch{return{success:!1,error:"Erro geral no teste"}}}async function De(){try{const{data:{user:s}}=await p.auth.getUser();if(!s)return{success:!1,error:"Usuário não autenticado"};const r={user_id:s.id,description:"Teste de autorização",amount:.01,transaction_type:"income",category:"Teste",transaction_date:new Date().toISOString().split("T")[0],account_id:"00000000-0000-0000-0000-000000000000",client_id:null},{error:i}=await p.from("transactions").insert([r]);return i?{success:!0,message:"client_id null não é o problema"}:{success:!0,message:"Teste passou"}}catch{return{success:!1,error:"Erro no teste"}}}function te(s){try{const r=new Date(s),i=r.getFullYear(),n=r.getMonth()+1;if(i!==2025)return null;const f=["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];return{table:`transactions_${i}_${String(n).padStart(2,"0")}`,month:f[n],monthNum:n,year:i}}catch{return null}}function Ee(s=2025){return["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].map((i,n)=>({table:`transactions_${s}_${String(n+1).padStart(2,"0")}`,month:i,monthNum:n+1,year:s}))}function Fe(s){return te(s)!==null}function $(s){const r=te(s);return r?r.table:"transactions"}async function re(s){try{const r=$(s.transaction_date),i=Fe(s.transaction_date),{data:n,error:f}=await p.from(r).insert([s]).select();return f?{success:!1,error:f.message,tableName:r}:{success:!0,tableName:r,data:n}}catch(r){return{success:!1,error:r.message,tableName:"unknown"}}}async function Ae(s,r,i){try{const n=$(r.transaction_date),f=$(i.transaction_date);if(n===f){const{data:y,error:d}=await p.from(n).update(i).eq("id",s).select();return d?{success:!1,error:d.message,tableName:n}:{success:!0,tableName:n,data:y}}const v=await re({...i});if(!v.success)return v;const{error:F}=await p.from(n).delete().eq("id",s);return v}catch(n){return{success:!1,error:n.message,tableName:"unknown"}}}async function ke(s,r){try{const i=$(r),{error:n}=await p.from(i).delete().eq("id",s);return n?{success:!1,error:n.message,tableName:i}:{success:!0,tableName:i}}catch(i){return{success:!1,error:i.message,tableName:"unknown"}}}const Ie=({children:s,feature:r,fallback:i})=>{const{isMasterUser:n,isTrialActive:f,canPerformAction:v,getPlanName:F,currentPlan:y}=se(),d=K(),[b,P]=G.useState(null);if(G.useEffect(()=>{(async()=>{if(n){P(!0);return}const T=await v(r);P(T)})()},[n,v,r]),b===null)return e.jsx(e.Fragment,{children:s});if(b)return e.jsx(e.Fragment,{children:s});if(i)return e.jsx(e.Fragment,{children:i});const z=()=>{switch(r){case"transaction":return"transações";case"user":return"usuários";case"client":return"clientes";default:return"recursos"}},V=()=>{switch(r){case"transaction":return e.jsx(ye,{className:"w-6 h-6"});case"user":return e.jsx(J,{className:"w-6 h-6"});case"client":return e.jsx(J,{className:"w-6 h-6"});default:return e.jsx(J,{className:"w-6 h-6"})}};return e.jsxs(Q,{className:"w-full max-w-md mx-auto",children:[e.jsxs(W,{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-4 p-3 bg-yellow-100 rounded-full w-fit",children:V()}),e.jsx(Z,{className:"text-lg",children:"Limite Atingido"}),e.jsxs(ee,{children:["Você atingiu o limite de ",z()," do seu plano atual."]})]}),e.jsxs(ae,{className:"space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["Plano atual: ",e.jsx("span",{className:"font-medium",children:F(y)})]}),f()&&e.jsx("p",{className:"text-sm text-blue-600 bg-blue-50 p-2 rounded",children:"⏰ Você está no período de teste gratuito"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"w-full",onClick:()=>d("/subscription"),children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),f()?"Escolher Plano":"Fazer Upgrade"]}),e.jsx(x,{variant:"outline",className:"w-full",onClick:()=>d("/dashboard"),children:"Voltar ao Dashboard"})]})]})]})};function sa(){const{user:s}=ue(),{canPerformAction:r,incrementUsage:i,isMasterUser:n,checkPlanLimits:f,subscription:v,usage:F}=se(),y=K(),{toast:d}=me(),[b,P]=w.useState([]),[z,V]=w.useState(!0),[U,T]=w.useState(!1),[h,M]=w.useState(null),[l,j]=w.useState({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),[c,A]=w.useState({month:"all",day:"all",type:"all",account:"all"}),[R,q]=w.useState([]),ne=[{id:"pj",name:"Conta PJ"},{id:"checkout",name:"Conta Checkout"}];w.useEffect(()=>{if(!s){y("/auth");return}O()},[s,y]);const B=()=>{A({month:"all",day:"all",type:"all",account:"all"}),q(b)};w.useEffect(()=>{let a=[...b];c.month&&c.month!=="all"&&(a=a.filter(t=>(new Date(t.transaction_date).getMonth()+1).toString()===c.month)),c.day&&c.day!=="all"&&(a=a.filter(t=>new Date(t.transaction_date).getDate().toString()===c.day)),c.type&&c.type!=="all"&&(a=a.filter(t=>t.transaction_type===c.type)),c.account&&c.account!=="all"&&(a=a.filter(t=>t.account_name===c.account)),q(a)},[b,c]);const O=async()=>{if(s)try{V(!0);let a=[];const t=Ee(2025);for(const m of t)try{const{data:N,error:k}=await p.from(m.table).select("*").eq("user_id",s.id);if(!k){const L=N||[];a=[...a,...L]}}catch{}try{const{data:m,error:N}=await p.from("transactions").select("*").eq("user_id",s.id);if(!N){const k=m||[];a=[...a,...k]}}catch{}const u=a.filter((m,N,k)=>N===k.findIndex(L=>L.id===m.id)).sort((m,N)=>new Date(N.transaction_date).getTime()-new Date(m.transaction_date).getTime());P(u),q(u)}catch{d({title:"Erro",description:"Erro inesperado ao carregar dados",variant:"destructive"})}finally{V(!1)}},ce=async a=>{if(a.preventDefault(),!n&&!await r("transaction")){d({title:"Limite Atingido",description:"Você atingiu o limite de transações do seu plano. Faça upgrade para continuar.",variant:"destructive"});return}try{if(!l.amount||parseFloat(l.amount)<=0){d({title:"Erro",description:"O valor deve ser maior que zero",variant:"destructive"});return}if(!l.account_name){d({title:"Erro",description:"Selecione uma conta",variant:"destructive"});return}let t=l.transaction_date;if(t){const[u,m,N]=t.split("-");t=`${u}-${m}-${N}`}const _={user_id:s.id,description:l.description||"",amount:parseFloat(l.amount),transaction_type:l.transaction_type,category:l.category||"",transaction_date:t,account_name:l.account_name,client_name:l.client_name||null};if(h){const u={user_id:h.user_id||s.id,description:h.description,amount:h.amount,transaction_type:h.transaction_type,category:h.category,transaction_date:h.transaction_date,account_name:h.account_name,client_name:h.client_name},m=await Ae(h.id,u,_);if(!m.success)throw new Error(m.error||"Erro ao atualizar transação");d({title:"Sucesso",description:`Transação atualizada com sucesso na tabela ${m.tableName}`})}else{const u=await re(_);if(!u.success)throw new Error(u.error||"Erro ao criar transação");d({title:"Sucesso",description:`Transação criada com sucesso na tabela ${u.tableName}`}),n||await i("transaction",1)}j({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),M(null),T(!1),O()}catch(t){t.code==="PGRST116"||t.message?.includes("permission")?d({title:"Erro de Autorização",description:"Você não tem permissão para realizar esta ação. Verifique se está logado corretamente.",variant:"destructive"}):d({title:"Erro",description:t.message||"Erro desconhecido ao processar transação",variant:"destructive"})}},oe=a=>{M(a),j({description:a.description,amount:a.amount.toString(),transaction_type:a.transaction_type,category:a.category||"",transaction_date:a.transaction_date,client_name:a.client_name||"",account_name:a.account_name}),T(!0)},ie=async a=>{if(confirm("Tem certeza que deseja excluir esta transação?"))try{const t=b.find(u=>u.id===a);if(!t)throw new Error("Transação não encontrada");const _=await ke(a,t.transaction_date);if(!_.success)throw new Error(_.error||"Erro ao excluir transação");d({title:"Sucesso",description:`Transação excluída com sucesso da tabela ${_.tableName}`}),O()}catch(t){t.code==="PGRST116"||t.message?.includes("permission")?d({title:"Erro de Autorização",description:"Você não tem permissão para excluir esta transação. Verifique se está logado corretamente.",variant:"destructive"}):d({title:"Erro",description:t.message||"Erro desconhecido ao excluir transação",variant:"destructive"})}},le=a=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a),de=async()=>{const a=await Se(),t=await De();a.success&&t.success?d({title:"Testes Concluídos",description:"Todos os testes de autorização passaram!"}):d({title:"Testes Falharam",description:`Problemas encontrados: ${a.error||t.error}`,variant:"destructive"})};return z?e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("p",{className:"ml-4 text-muted-foreground",children:"Carregando transações..."})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(x,{variant:"ghost",onClick:()=>y("/dashboard"),children:"← Dashboard"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Transações"}),e.jsx(x,{variant:"outline",size:"sm",onClick:de,className:"ml-4",children:"🧪 Testar Auth"})]}),e.jsx(Ie,{feature:"transaction",children:e.jsxs(he,{open:U,onOpenChange:T,children:[e.jsx(xe,{asChild:!0,children:e.jsxs(x,{onClick:()=>{M(null),j({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_id:"",account_id:""})},children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Nova Transação"]})}),e.jsxs(pe,{className:"sm:max-w-[500px]",children:[e.jsxs(fe,{children:[e.jsx(je,{children:h?"Editar Transação":"Nova Transação"}),e.jsx(ge,{children:h?"Edite os dados da transação":"Adicione uma nova transação financeira"})]}),e.jsxs("form",{onSubmit:ce,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"description",children:"Descrição (Opcional)"}),e.jsx(I,{id:"description",placeholder:"Descrição da transação",value:l.description,onChange:a=>j({...l,description:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"amount",children:"Valor"}),e.jsx(I,{id:"amount",type:"number",step:"0.01",placeholder:"0,00",value:l.amount,onChange:a=>j({...l,amount:a.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"transaction_type",children:"Tipo"}),e.jsxs(C,{value:l.transaction_type,onValueChange:a=>j({...l,transaction_type:a}),children:[e.jsx(S,{children:e.jsx(D,{})}),e.jsxs(E,{children:[e.jsx(o,{value:"income",children:"Receita"}),e.jsx(o,{value:"expense",children:"Despesa"}),e.jsx(o,{value:"transfer",children:"Transferência"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"account_name",children:"Conta"}),e.jsxs(C,{value:l.account_name||void 0,onValueChange:a=>j({...l,account_name:a}),children:[e.jsx(S,{children:e.jsx(D,{placeholder:"Selecione uma conta"})}),e.jsx(E,{children:ne.map(a=>e.jsx(o,{value:a.name,children:a.name},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"client_name",children:"Cliente (Opcional)"}),e.jsx(I,{id:"client_name",placeholder:"Digite o nome do cliente",value:l.client_name,onChange:a=>j({...l,client_name:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"category",children:"Categoria"}),e.jsx(I,{id:"category",placeholder:"Ex: Vendas, Marketing",value:l.category,onChange:a=>j({...l,category:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"transaction_date",children:"Data"}),e.jsx(I,{id:"transaction_date",type:"date",value:l.transaction_date,onChange:a=>j({...l,transaction_date:a.target.value}),required:!0})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>T(!1),children:"Cancelar"}),e.jsx(x,{type:"submit",children:h?"Atualizar":"Criar"})]})]})]})]})})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:e.jsxs(Q,{className:"shadow-finance-md",children:[e.jsxs(W,{children:[e.jsx(Z,{children:"Lista de Transações"}),e.jsx(ee,{children:"Gerencie todas as suas movimentações financeiras"})]}),e.jsx("div",{className:"px-6 pb-4 border-b",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Filtros:"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"month-filter",className:"text-xs",children:"Mês:"}),e.jsxs(C,{value:c.month,onValueChange:a=>A({...c,month:a}),children:[e.jsx(S,{className:"w-32 h-8",children:e.jsx(D,{placeholder:"Todos"})}),e.jsxs(E,{children:[e.jsx(o,{value:"all",children:"Todos"}),e.jsx(o,{value:"1",children:"Janeiro"}),e.jsx(o,{value:"2",children:"Fevereiro"}),e.jsx(o,{value:"3",children:"Março"}),e.jsx(o,{value:"4",children:"Abril"}),e.jsx(o,{value:"5",children:"Maio"}),e.jsx(o,{value:"6",children:"Junho"}),e.jsx(o,{value:"7",children:"Julho"}),e.jsx(o,{value:"8",children:"Agosto"}),e.jsx(o,{value:"9",children:"Setembro"}),e.jsx(o,{value:"10",children:"Outubro"}),e.jsx(o,{value:"11",children:"Novembro"}),e.jsx(o,{value:"12",children:"Dezembro"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"day-filter",className:"text-xs",children:"Dia:"}),e.jsxs(C,{value:c.day,onValueChange:a=>A({...c,day:a}),children:[e.jsx(S,{className:"w-20 h-8",children:e.jsx(D,{placeholder:"Todos"})}),e.jsxs(E,{children:[e.jsx(o,{value:"all",children:"Todos"}),Array.from({length:31},(a,t)=>t+1).map(a=>e.jsx(o,{value:a.toString(),children:a},a))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"type-filter",className:"text-xs",children:"Tipo:"}),e.jsxs(C,{value:c.type,onValueChange:a=>A({...c,type:a}),children:[e.jsx(S,{className:"w-28 h-8",children:e.jsx(D,{placeholder:"Todos"})}),e.jsxs(E,{children:[e.jsx(o,{value:"all",children:"Todos"}),e.jsx(o,{value:"income",children:"Receita"}),e.jsx(o,{value:"expense",children:"Despesa"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{htmlFor:"account-filter",className:"text-xs",children:"Conta:"}),e.jsxs(C,{value:c.account,onValueChange:a=>A({...c,account:a}),children:[e.jsx(S,{className:"w-32 h-8",children:e.jsx(D,{placeholder:"Todas"})}),e.jsxs(E,{children:[e.jsx(o,{value:"all",children:"Todas"}),e.jsx(o,{value:"Conta PJ",children:"Conta PJ"}),e.jsx(o,{value:"Conta Checkout",children:"Conta Checkout"})]})]})]}),(c.month!=="all"||c.day!=="all"||c.type!=="all"||c.account!=="all")&&e.jsxs(x,{variant:"outline",size:"sm",onClick:B,className:"h-8",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),"Limpar"]}),e.jsxs("div",{className:"ml-auto text-xs text-muted-foreground",children:[R.length," de ",b.length," transações"]})]})}),e.jsx(ae,{children:z?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando transações..."})]}):R.length===0?e.jsx("div",{className:"text-center py-8",children:b.length===0?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transação encontrada. Adicione sua primeira transação."}),e.jsxs(x,{onClick:()=>{M(null),j({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),T(!0)},children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Nova Transação"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transação encontrada com os filtros aplicados."}),e.jsxs(x,{variant:"outline",onClick:B,children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})]})}):e.jsx("div",{className:"space-y-4",children:R.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`p-2 rounded-full ${a.transaction_type==="income"?"bg-success/10":a.transaction_type==="expense"?"bg-destructive/10":"bg-info/10"}`,children:a.transaction_type==="income"?e.jsx(be,{className:"h-4 w-4 text-success"}):a.transaction_type==="expense"?e.jsx(_e,{className:"h-4 w-4 text-destructive"}):e.jsx(we,{className:"h-4 w-4 text-info"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.description||"Sem descrição"}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:a.client_name||"Sem cliente"}),e.jsx("span",{children:"•"}),e.jsx("span",{children:a.account_name}),e.jsx("span",{children:"•"}),e.jsx("span",{children:new Date(a.transaction_date).toLocaleDateString("pt-BR")}),a.category&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsx("span",{children:a.category})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`font-semibold ${a.transaction_type==="income"?"text-success":a.transaction_type==="expense"?"text-destructive":"text-info"}`,children:[a.transaction_type==="income"?"+":a.transaction_type==="expense"?"-":"",le(Number(a.amount))]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>oe(a),children:e.jsx(Te,{className:"w-4 h-4"})}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>ie(a.id),children:e.jsx(Ce,{className:"w-4 h-4"})})]})]})]},a.id))})})]})})]})}export{sa as default};
