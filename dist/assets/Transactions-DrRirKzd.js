import{j as e}from"./ui-Cnk5WNzt.js";import{r as v}from"./vendor-CZTyH7vC.js";import{c as ee,s as m,b as ae,d as se,u as te,a as re,e as ne,X as J}from"./index-DMPpfWZc.js";import{C as U,S as T,a as w,b as C,c as S,d as i}from"./select-Dxcty8jL.js";import{C as oe,a as ce,b as ie,c as le,d as de}from"./card-CNKSsfyp.js";import{B as f}from"./button-BiYs1Tae.js";import{I as k}from"./input-DOAzSnWi.js";import{L as x}from"./label-BH8Z3DW0.js";import{D as ue,a as me,b as he,c as xe,d as pe,e as fe,S as je,T as ge}from"./dialog-Bd6VSDNs.js";import{P}from"./plus-BcjBAqMl.js";import{F as L}from"./filter-DqFWL5LA.js";import{D as ve}from"./dollar-sign-CW35_ZFW.js";import{A as ye,a as be}from"./arrow-up-right-Cdiw-2zv.js";import"./supabase-DfbQpoin.js";import"./charts-DE-LwN1H.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=ee("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]);async function Ne(){try{const{data:{user:s},error:n}=await m.auth.getUser();if(n)return{success:!1,error:"Erro de autenticação"};if(!s)return{success:!1,error:"Usuário não autenticado"};const{data:t,error:r}=await m.from("transactions").select("*").limit(1);if(r)return{success:!1,error:`Erro transações: ${r.message}`};const{data:j,error:g}=await m.from("clients").select("*").limit(1);if(g)return{success:!1,error:`Erro clientes: ${g.message}`};const{data:D,error:_}=await m.from("accounts").select("*").limit(1);return _?{success:!1,error:`Erro contas: ${_.message}`}:{success:!0}}catch{return{success:!1,error:"Erro geral no teste"}}}async function _e(){try{const{data:{user:s}}=await m.auth.getUser();if(!s)return{success:!1,error:"Usuário não autenticado"};const n={user_id:s.id,description:"Teste de autorização",amount:.01,transaction_type:"income",category:"Teste",transaction_date:new Date().toISOString().split("T")[0],account_id:"00000000-0000-0000-0000-000000000000",client_id:null},{error:t}=await m.from("transactions").insert([n]);return t?{success:!0,message:"client_id null não é o problema"}:{success:!0,message:"Teste passou"}}catch{return{success:!1,error:"Erro no teste"}}}function q(s){try{const n=new Date(s),t=n.getFullYear(),r=n.getMonth()+1;if(t!==2025)return null;const j=["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];return{table:`transactions_${t}_${String(r).padStart(2,"0")}`,month:j[r],monthNum:r,year:t}}catch{return null}}function Te(s=2025){return["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"].map((t,r)=>({table:`transactions_${s}_${String(r+1).padStart(2,"0")}`,month:t,monthNum:r+1,year:s}))}function G(s){return q(s)!==null}function z(s){const n=q(s);return n?n.table:"transactions"}async function H(s){try{const n=z(s.transaction_date),t=G(s.transaction_date),{data:r,error:j}=await m.from(n).insert([s]).select();return j?{success:!1,error:j.message,tableName:n}:{success:!0,tableName:n,data:r}}catch(n){return{success:!1,error:n.message,tableName:"unknown"}}}async function we(s,n,t){try{const r=z(n.transaction_date),j=z(t.transaction_date);if(r===j){const{data:_,error:y}=await m.from(r).update(t).eq("id",s).select();return y?{success:!1,error:y.message,tableName:r}:{success:!0,tableName:r,data:_}}const g=await H({...t});if(!g.success)return g;const{error:D}=await m.from(r).delete().eq("id",s);return g}catch(r){return{success:!1,error:r.message,tableName:"unknown"}}}async function Ce(s,n){try{const t=z(n),{error:r}=await m.from(t).delete().eq("id",s);return r?{success:!1,error:r.message,tableName:t}:{success:!0,tableName:t}}catch(t){return{success:!1,error:t.message,tableName:"unknown"}}}const Se=se("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function I({className:s,variant:n,...t}){return e.jsx("div",{className:ae(Se({variant:n}),s),...t})}function De({transactionDate:s,className:n=""}){if(!s)return null;const t=G(s),r=q(s);return t&&r?e.jsxs("div",{className:`flex items-center gap-2 ${n}`,children:[e.jsx(B,{className:"h-4 w-4 text-blue-600"}),e.jsxs(I,{variant:"secondary",className:"text-xs",children:["Tabela: ",r.table]}),e.jsxs(I,{variant:"outline",className:"text-xs",children:[r.month,"/",r.year]})]}):e.jsxs("div",{className:`flex items-center gap-2 ${n}`,children:[e.jsx(B,{className:"h-4 w-4 text-gray-600"}),e.jsx(I,{variant:"secondary",className:"text-xs",children:"Tabela: transactions (principal)"}),e.jsxs(I,{variant:"outline",className:"text-xs",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Outras datas"]})]})}function Be(){const{user:s}=te(),n=re(),{toast:t}=ne(),[r,j]=v.useState([]),[g,D]=v.useState(!0),[_,y]=v.useState(!1),[d,A]=v.useState(null),[l,h]=v.useState({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),[c,E]=v.useState({month:"all",day:"all",type:"all",account:"all"}),[M,V]=v.useState([]),X=[{id:"pj",name:"Conta PJ"},{id:"checkout",name:"Conta Checkout"}];v.useEffect(()=>{if(!s){n("/auth");return}$()},[s,n]);const R=()=>{E({month:"all",day:"all",type:"all",account:"all"}),V(r)};v.useEffect(()=>{let a=[...r];c.month&&c.month!=="all"&&(a=a.filter(o=>(new Date(o.transaction_date).getMonth()+1).toString()===c.month)),c.day&&c.day!=="all"&&(a=a.filter(o=>new Date(o.transaction_date).getDate().toString()===c.day)),c.type&&c.type!=="all"&&(a=a.filter(o=>o.transaction_type===c.type)),c.account&&c.account!=="all"&&(a=a.filter(o=>o.account_name===c.account)),V(a)},[r,c]);const $=async()=>{if(s)try{D(!0);let a=[];const o=Te(2025);for(const b of o)try{const{data:N,error:F}=await m.from(b.table).select("*").eq("user_id",s.id);if(!F){const O=N||[];a=[...a,...O]}}catch{}try{const{data:b,error:N}=await m.from("transactions").select("*").eq("user_id",s.id);if(!N){const F=b||[];a=[...a,...F]}}catch{}const p=a.filter((b,N,F)=>N===F.findIndex(O=>O.id===b.id)).sort((b,N)=>new Date(N.transaction_date).getTime()-new Date(b.transaction_date).getTime());j(p),V(p)}catch{t({title:"Erro",description:"Erro inesperado ao carregar dados",variant:"destructive"})}finally{D(!1)}},Y=async a=>{if(a.preventDefault(),!!s){if(!l.account_name){t({title:"Erro",description:"Selecione uma conta para a transação",variant:"destructive"});return}try{const o={user_id:s.id,description:l.description,amount:parseFloat(l.amount),transaction_type:l.transaction_type,category:l.category,transaction_date:l.transaction_date,account_name:l.account_name,client_name:l.client_name||null};if(d){const u={user_id:d.user_id||s.id,description:d.description,amount:d.amount,transaction_type:d.transaction_type,category:d.category,transaction_date:d.transaction_date,account_name:d.account_name,client_name:d.client_name},p=await we(d.id,u,o);if(!p.success)throw new Error(p.error||"Erro ao atualizar transação");t({title:"Sucesso",description:`Transação atualizada com sucesso na tabela ${p.tableName}`})}else{const u=await H(o);if(!u.success)throw new Error(u.error||"Erro ao criar transação");t({title:"Sucesso",description:`Transação criada com sucesso na tabela ${u.tableName}`})}h({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),A(null),y(!1),$()}catch(o){o.code==="PGRST116"||o.message?.includes("permission")?t({title:"Erro de Autorização",description:"Você não tem permissão para realizar esta ação. Verifique se está logado corretamente.",variant:"destructive"}):t({title:"Erro",description:o.message||"Erro desconhecido ao processar transação",variant:"destructive"})}}},K=a=>{A(a),h({description:a.description,amount:a.amount.toString(),transaction_type:a.transaction_type,category:a.category||"",transaction_date:a.transaction_date,client_name:a.client_name||"",account_name:a.account_name}),y(!0)},Q=async a=>{if(confirm("Tem certeza que deseja excluir esta transação?"))try{const o=r.find(p=>p.id===a);if(!o)throw new Error("Transação não encontrada");const u=await Ce(a,o.transaction_date);if(!u.success)throw new Error(u.error||"Erro ao excluir transação");t({title:"Sucesso",description:`Transação excluída com sucesso da tabela ${u.tableName}`}),$()}catch(o){o.code==="PGRST116"||o.message?.includes("permission")?t({title:"Erro de Autorização",description:"Você não tem permissão para excluir esta transação. Verifique se está logado corretamente.",variant:"destructive"}):t({title:"Erro",description:o.message||"Erro desconhecido ao excluir transação",variant:"destructive"})}},W=a=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a),Z=async()=>{const a=await Ne(),o=await _e();a.success&&o.success?t({title:"Testes Concluídos",description:"Todos os testes de autorização passaram!"}):t({title:"Testes Falharam",description:`Problemas encontrados: ${a.error||o.error}`,variant:"destructive"})};return g?e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("p",{className:"ml-4 text-muted-foreground",children:"Carregando transações..."})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b bg-card",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(f,{variant:"ghost",onClick:()=>n("/dashboard"),children:"← Dashboard"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Transações"}),e.jsx(f,{variant:"outline",size:"sm",onClick:Z,className:"ml-4",children:"🧪 Testar Auth"})]}),e.jsxs(ue,{open:_,onOpenChange:y,children:[e.jsx(me,{asChild:!0,children:e.jsxs(f,{onClick:()=>{A(null),h({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_id:"",account_id:""})},children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),"Nova Transação"]})}),e.jsxs(he,{className:"sm:max-w-[500px]",children:[e.jsxs(xe,{children:[e.jsx(pe,{children:d?"Editar Transação":"Nova Transação"}),e.jsx(fe,{children:d?"Edite os dados da transação":"Adicione uma nova transação financeira"})]}),e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"description",children:"Descrição (Opcional)"}),e.jsx(k,{id:"description",placeholder:"Descrição da transação",value:l.description,onChange:a=>h({...l,description:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"amount",children:"Valor"}),e.jsx(k,{id:"amount",type:"number",step:"0.01",placeholder:"0,00",value:l.amount,onChange:a=>h({...l,amount:a.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"transaction_type",children:"Tipo"}),e.jsxs(T,{value:l.transaction_type,onValueChange:a=>h({...l,transaction_type:a}),children:[e.jsx(w,{children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(i,{value:"income",children:"Receita"}),e.jsx(i,{value:"expense",children:"Despesa"}),e.jsx(i,{value:"transfer",children:"Transferência"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"account_name",children:"Conta"}),e.jsxs(T,{value:l.account_name||void 0,onValueChange:a=>h({...l,account_name:a}),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Selecione uma conta"})}),e.jsx(S,{children:X.map(a=>e.jsx(i,{value:a.name,children:a.name},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"client_name",children:"Cliente (Opcional)"}),e.jsx(k,{id:"client_name",placeholder:"Digite o nome do cliente",value:l.client_name,onChange:a=>h({...l,client_name:a.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"category",children:"Categoria"}),e.jsx(k,{id:"category",placeholder:"Ex: Vendas, Marketing",value:l.category,onChange:a=>h({...l,category:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"transaction_date",children:"Data"}),e.jsx(k,{id:"transaction_date",type:"date",value:l.transaction_date,onChange:a=>h({...l,transaction_date:a.target.value}),required:!0}),e.jsx(De,{transactionDate:l.transaction_date,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(f,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"}),e.jsx(f,{type:"submit",children:d?"Atualizar":"Criar"})]})]})]})]})]})}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:e.jsxs(oe,{className:"shadow-finance-md",children:[e.jsxs(ce,{children:[e.jsx(ie,{children:"Lista de Transações"}),e.jsx(le,{children:"Gerencie todas as suas movimentações financeiras"})]}),e.jsx("div",{className:"px-6 pb-4 border-b",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Filtros:"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"month-filter",className:"text-xs",children:"Mês:"}),e.jsxs(T,{value:c.month,onValueChange:a=>E({...c,month:a}),children:[e.jsx(w,{className:"w-32 h-8",children:e.jsx(C,{placeholder:"Todos"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todos"}),e.jsx(i,{value:"1",children:"Janeiro"}),e.jsx(i,{value:"2",children:"Fevereiro"}),e.jsx(i,{value:"3",children:"Março"}),e.jsx(i,{value:"4",children:"Abril"}),e.jsx(i,{value:"5",children:"Maio"}),e.jsx(i,{value:"6",children:"Junho"}),e.jsx(i,{value:"7",children:"Julho"}),e.jsx(i,{value:"8",children:"Agosto"}),e.jsx(i,{value:"9",children:"Setembro"}),e.jsx(i,{value:"10",children:"Outubro"}),e.jsx(i,{value:"11",children:"Novembro"}),e.jsx(i,{value:"12",children:"Dezembro"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"day-filter",className:"text-xs",children:"Dia:"}),e.jsxs(T,{value:c.day,onValueChange:a=>E({...c,day:a}),children:[e.jsx(w,{className:"w-20 h-8",children:e.jsx(C,{placeholder:"Todos"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todos"}),Array.from({length:31},(a,o)=>o+1).map(a=>e.jsx(i,{value:a.toString(),children:a},a))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"type-filter",className:"text-xs",children:"Tipo:"}),e.jsxs(T,{value:c.type,onValueChange:a=>E({...c,type:a}),children:[e.jsx(w,{className:"w-28 h-8",children:e.jsx(C,{placeholder:"Todos"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todos"}),e.jsx(i,{value:"income",children:"Receita"}),e.jsx(i,{value:"expense",children:"Despesa"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"account-filter",className:"text-xs",children:"Conta:"}),e.jsxs(T,{value:c.account,onValueChange:a=>E({...c,account:a}),children:[e.jsx(w,{className:"w-32 h-8",children:e.jsx(C,{placeholder:"Todas"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"Todas"}),e.jsx(i,{value:"Conta PJ",children:"Conta PJ"}),e.jsx(i,{value:"Conta Checkout",children:"Conta Checkout"})]})]})]}),(c.month!=="all"||c.day!=="all"||c.type!=="all"||c.account!=="all")&&e.jsxs(f,{variant:"outline",size:"sm",onClick:R,className:"h-8",children:[e.jsx(J,{className:"h-3 w-3 mr-1"}),"Limpar"]}),e.jsxs("div",{className:"ml-auto text-xs text-muted-foreground",children:[M.length," de ",r.length," transações"]})]})}),e.jsx(de,{children:g?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando transações..."})]}):M.length===0?e.jsx("div",{className:"text-center py-8",children:r.length===0?e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transação encontrada. Adicione sua primeira transação."}),e.jsxs(f,{onClick:()=>{A(null),h({description:"",amount:"",transaction_type:"income",category:"",transaction_date:new Date().toISOString().split("T")[0],client_name:"",account_name:""}),y(!0)},children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),"Nova Transação"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Nenhuma transação encontrada com os filtros aplicados."}),e.jsxs(f,{variant:"outline",onClick:R,children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})]})}):e.jsx("div",{className:"space-y-4",children:M.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg border hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`p-2 rounded-full ${a.transaction_type==="income"?"bg-success/10":a.transaction_type==="expense"?"bg-destructive/10":"bg-info/10"}`,children:a.transaction_type==="income"?e.jsx(ye,{className:"h-4 w-4 text-success"}):a.transaction_type==="expense"?e.jsx(be,{className:"h-4 w-4 text-destructive"}):e.jsx(U,{className:"h-4 w-4 text-info"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.description||"Sem descrição"}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:a.client_name||"Sem cliente"}),e.jsx("span",{children:"•"}),e.jsx("span",{children:a.account_name}),e.jsx("span",{children:"•"}),e.jsx("span",{children:new Date(a.transaction_date).toLocaleDateString("pt-BR")}),a.category&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsx("span",{children:a.category})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`font-semibold ${a.transaction_type==="income"?"text-success":a.transaction_type==="expense"?"text-destructive":"text-info"}`,children:[a.transaction_type==="income"?"+":a.transaction_type==="expense"?"-":"",W(Number(a.amount))]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(f,{size:"sm",variant:"ghost",onClick:()=>K(a),children:e.jsx(je,{className:"w-4 h-4"})}),e.jsx(f,{size:"sm",variant:"ghost",onClick:()=>Q(a.id),children:e.jsx(ge,{className:"w-4 h-4"})})]})]})]},a.id))})})]})})]})}export{Be as default};
